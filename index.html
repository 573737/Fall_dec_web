<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Real-Time Sensor Data with Predictions</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script> <!-- TensorFlow.js -->
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }

    #sensorOutput {
      text-align: center;
      border: 1px solid #ccc;
      padding: 20px;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .sensorWidget {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .sensorWidget div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      background-color: #f2f2f2;
      border-radius: 5px;
    }

    .sensorWidget label {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="sensorOutput">
    <h2>Sensor Data with Predictions</h2>
    <div id="sensorWidgetContainer">
      <!-- Widget content will be added here -->
    </div>
  </div>

  <script>
    // Load TensorFlow.js model
    let model;
    (async () => {
      try {
        model = await tf.loadGraphModel('./model.json'); // Path to your TensorFlow.js model
      } catch (error) {
        console.error("Error loading model:", error);
      }
    })();

    const sensorWidgetContainer = document.getElementById("sensorWidgetContainer");

    // Function to add a sensor data widget with prediction
    async function addSensorDataWithPrediction() {
      const currentTime = new Date().toLocaleTimeString();

      // Normalization function and ranges
      function normalize(value, min, max) {
        return (value - min) / (max - min);
      }

      const expectedRanges = {
        velocity: { min: -10, max: 10 },
        orientation: { min: 0, max: 360 },
        acceleration: { min: -10, max: 10 },
        gyroscope: { min: -250, max: 250 },
        magnetometer: { min: -100, max: 100 },
      };

      const normalizedData = {
        velocity: {
          x: normalize(velocity.x, expectedRanges.velocity.min, expectedRanges.velocity.max),
          y: normalize(velocity.y, expectedRanges.velocity.min, expectedRanges.velocity.max),
          z: normalize(velocity.z, expectedRanges.velocity.min, expectedRanges.velocity.max),
        },
        orientation: {
          w: normalize(orientation.w, expectedRanges.orientation.min, expectedRanges.orientation.max),
          x: normalize(orientation.x, expectedRanges.orientation.min, expectedRanges.orientation.max),
          y: normalize(orientation.y, expectedRanges.orientation.min, expectedRanges.orientation.max),
          z: normalize(orientation.z, expectedRanges.orientation.min, expectedRanges.orientation.max),
        },
        acceleration: {
          x: normalize(acceleration.x, expectedRanges.acceleration.min, expectedRanges.acceleration.max),
          y: normalize(acceleration.y, expectedRanges.acceleration.min, expectedRanges.acceleration.max),
          z: normalize(acceleration.z, expectedRanges.acceleration.min, expectedRanges.acceleration.max),
        },
        gyroscope: {
          x: normalize(gyroscope.x, expectedRanges.gyroscope.min, expectedRanges.gyroscope.max),
          y: normalize(gyroscope.y, expectedRanges.gyroscope.min, expectedRanges.gyroscope.max),
          z: normalize(gyroscope.z, expectedRanges.gyroscope.min, expectedRanges.gyroscope.max),
        },
        magnetometer: {
          x: normalize(magnetometer.x, expectedRanges.magnetometer.min, expectedRanges.magnetometer.max),
          y: normalize(magnetometer.y, expectedRanges.magnetometer.min, expectedRanges.magnetometer.max),
          z: normalize(magnetometer.z, expectedRanges.magnetometer.min, expectedRanges.magnetometer.max),
        },
      };

      // Example data for TensorFlow.js prediction
      const exampleData = [
        normalizedData.velocity.x,
        normalizedData.velocity.y,
        normalizedData.velocity.z,
        normalizedData.orientation.w,
        normalizedData.orientation.x,
        normalizedData.orientation.y,
        normalizedData.orientation.z,
        normalizedData.acceleration.x,
        normalizedData.acceleration.y,
        normalizedData.acceleration.z,
        normalizedData.gyroscope.x,
        normalizedData.gyroscope.y,
        normalizedData.gyroscope.z,
        normalizedData.magnetometer.x,
        normalizedData.magnetometer.y,
        normalizedData.magnetometer.z,
        normalizedData.orientation.y, // Roll
        normalizedData.orientation.x, // Pitch
        normalizedData.orientation.w, // Yaw
      ];

      let predictionValue = "N/A"; // Default value if the model isn't loaded

      if (model) {
        const inputTensor = tf.tensor2d([exampleData], [1, 19], 'float32'); // Create input tensor
        const prediction = model.predict(inputTensor);
        const predictedValue = (await prediction.data())[0]; // Raw prediction value

        // Determine if the prediction indicates stable or unstable
        if (predictedValue < 18) {
          predictionValue = `${predictedValue.toFixed(2)} - Stable`;
        } else {
          predictionValue = `${predictedValue.toFixed(2)} - Unstable`;
        }
      }

      const sensorWidget = document.createElement("div");
      sensorWidget.classList.add("sensorWidget");

      sensorWidget.innerHTML = `
        <div><label>Time:</label> ${currentTime}</div>
        <div><label>VelInc_X:</label> ${normalizedData.velocity.x.toFixed(2)}</div>
        <div><label>VelInc_Y:</label> ${normalizedData.velocity.y.toFixed(2)}</div>
        <div><label>VelInc_Z:</label> ${normalizedData.velocity.z.toFixed(2)}</div>
        <div><label>OriInc_w:</label> ${normalizedData.orientation.w.toFixed(2)}</div>
        <div><label>OriInc_x:</label> ${normalizedData.orientation.x.toFixed(2)}</div>
        <div><label>OriInc_y:</label> ${normalizedData.orientation.y.toFixed(2)}</div>
        <div><label>OriInc_z:</label> ${normalizedData.orientation.z.toFixed(2)}</div>
        <div><label>Acc_X:</label> ${normalizedData.acceleration.x.toFixed(2)}</div>
        <div><label>Acc_Y:</label> ${normalizedData.acceleration.y.toFixed(2)}</div>
        <div><label>Acc_Z:</label> ${normalizedData.acceleration.z.toFixed(2)}</div>
        <div><label>Gyr_X:</label> ${normalizedData.gyroscope.x.toFixed(2)}</div>
        <div><label>Gyr_Y:</label> ${normalizedData.gyroscope.y.toFixed(2)}</div>
        <div><label>Gyr_Z:</label> ${normalizedData.gyroscope.z.toFixed(2)}</div>
        <div><label>Mag_X:</label> ${normalizedData.magnetometer.x.toFixed(2)}</div>
        <div><label>Mag_Y:</label> ${normalizedData.magnetometer.y.toFixed(2)}</div>
        <div><label>Mag_Z:</label> ${normalizedData.magnetometer.z.toFixed(2)}</div>
        <div><label>Roll:</label> ${normalizedData.orientation.y.toFixed(2)}</div>
        <div><label>Pitch:</label> ${normalizedData.orientation.x.toFixed(2)}</div>
        <div><label>Yaw:</label> ${normalizedData.orientation.w.toFixed(2)}</div>
        <div><label>Prediction:</label> ${predictionValue}</div>
      `;

      sensorWidgetContainer.appendChild(sensorWidget);
    }

    // Listen for device motion and orientation events
    window.addEventListener("devicemotion", (event) => {
      const { acceleration, rotationRate, timeStamp } = event;

      if (acceleration) {
        if (lastTimestamp !== null) {
          const dt = (timeStamp - lastTimestamp) / 1000;

          velocity.x += (acceleration.x ?? 0) * dt;
          velocity.y += (acceleration.y ?? 0) * dt;
          velocity.z += (acceleration.z ?? 0) * dt;
        }

        lastTimestamp = timeStamp;

        acceleration.x = acceleration.x ?? 0;
        acceleration.y = acceleration.y ?? 0;
        acceleration.z = acceleration.z ?? 0;
      }

      if (rotationRate) {
        gyroscope.x = rotationRate.alpha ?? 0;
        gyroscope.y = rotationRate.beta ?? 0;
        gyroscope.z = rotationRate.gamma ?? 0;
      }
    });

    window.addEventListener("deviceorientation", (event) => {
      const { alpha, beta, gamma } = event;

      orientation.w = alpha ?? 0;
      orientation.x = beta ?? 0;
      orientation.y = gamma ?? 0;
      orientation.z = alpha ?? 0;
    });

    setInterval(() => {
      addSensorDataWithPrediction();
    }, 3000); // 3-second interval
  </script>

</body>

</html>