<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Real-Time Sensor Data with Predictions</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<style>
body {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background-color: #f0f0f0;
  font-family: Arial, sans-serif;
}
#sensorOutput {
  text-align: center;
  border: 1px solid #ccc;
  padding: 20px;
  background-color: white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
#sensorTable {
  width: 100%;
  border-collapse: collapse;
}
#sensorTable th,
#sensorTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
#sensorTable th {
  background-color: #f2f2f2;
}
</style>
</head>
<body>
<div id="sensorOutput">
  <h2>Sensor Data Table with Predictions</h2>
  <table id="sensorTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Vel_X</th>
        <th>Vel_Y</th>
        <th>Vel_Z</th>
        <th>Acc_X</th>
        <th>Acc_Y</th>
        <th>Acc_Z</th>
        <th>Gyro_X</th>
        <th>Gyro_Y</th>
        <th>Gyro_Z</th>
        <th>Ori_Alpha</th>
        <th>Ori_Beta</th>
        <th>Ori_Gamma</th>
        <th>Yaw</th>
        <th>Pitch</th>
        <th>Roll</th>
        <th>Prediction</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be added here -->
    </tbody>
  </table>
</div>

<script>
// Load TensorFlow.js model
let model;
(async () => {
  try {
    model = await tf.loadGraphModel('./model.json');
  } catch (error) {
    console.error("Error loading model:", error);
  }
})();

const sensorTableBody = document.getElementById("sensorTable").querySelector("tbody");

let velocity = { x: 0, y: 0, z: 0 };
let acceleration = { x: 0, y: 0, z: 0 };
let gyroscope = { x: 0, y: 0, z: 0 };
let orientation = { alpha: 0, beta: 0, gamma: 0 };
let lastTimestamp = null;

// Normalization function
function normalize(value, min, max) {
  if (min >= max) return 0; // Avoid division by zero
  return (value - min) / (max - min);
}

// Function to add sensor data and predictions to the table
async function addSensorDataWithPrediction() {
  const newRow = document.createElement("tr");

  const currentTime = new Date().toLocaleTimeString();

  const normalizedVelocity = {
    x: normalize(velocity.x, -10, 10),
    y: normalize(velocity.y, -10, 10),
    z: normalize(velocity.z, -10, 10),
  };

  const normalizedAcceleration = {
    x: normalize(acceleration.x, -10, 10),
    y: normalize(acceleration.y, -10, 10),
    z: normalize(acceleration.z, -10, 10),
  };

  const normalizedGyroscope = {
    x: normalize(gyroscope.x, -250, 250),
    y: normalize(gyroscope.y, -250, 250),
    z: normalize(gyroscope.z, -250, 250),
  };

  const normalizedOrientation = {
    alpha: normalize(orientation.alpha, 0, 360),
    beta: normalize(orientation.beta, 0, 360),
    gamma: normalize(orientation.gamma, 0, 360),
  };

  const exampleData = [
    normalizedVelocity.x,
    normalizedVelocity.y,
    normalizedVelocity.z,
    normalizedAcceleration.x,
    normalizedAcceleration.y,
    normalizedAcceleration.z,
    normalizedGyroscope.x,
    normalizedGyroscope.y,
    normalizedGyroscope.z,
    normalizedOrientation.alpha,
    normalizedOrientation.beta,
    normalizedOrientation.gamma,
  ];

  let predictionValue = "N/A";
  if (model) {
    const inputTensor = tf.tensor2d([exampleData], [1, 12], 'float32');
    const prediction = model.predict(inputTensor);
    predictionValue = (await prediction.data())[0].toFixed(2);
    inputTensor.dispose();
  }

  newRow.innerHTML = `
    <td>${currentTime}</td>
    <td>${velocity.x.toFixed(2)}</td>
    <td>${velocity.y.toFixed(2)}</td>
    <td>${velocity.z.toFixed(2)}</td>
    <td>${acceleration.x.toFixed(2)}</td>
    <td>${acceleration.y.toFixed(2)}</td>
    <td>${acceleration.z.toFixed(2)}</td>
    <td>${gyroscope.x.toFixed(2)}</td>
    <td>${gyroscope.y.toFixed(2)}</td>
    <td>${gyroscope.z.toFixed(2)}</td>
    <td>${orientation.alpha.toFixed(2)}</td>
    <td>${orientation.beta.toFixed(2)}</td>
    <td>${orientation.gamma.toFixed(2)}</td>
    <td>${orientation.alpha.toFixed(2)}</td>
    <td>${orientation.beta.toFixed(2)}</td>
    <td>${orientation.gamma.toFixed(2)}</td>
    <td>${predictionValue}</td>
  `;

  sensorTableBody.appendChild(newRow);
}

window.addEventListener("devicemotion", (event) => {
  const { acceleration, rotationRate, timeStamp } = event;

  if (acceleration) {
    if (lastTimestamp !== null) {
      const dt = (timeStamp - lastTimestamp) / 1000; // Convert to seconds

      velocity.x += (acceleration.x ?? 0) * dt;
      velocity.y += (acceleration.y ?? 0) * dt;
      velocity.z += (acceleration.z ?? 0) * dt;
    }

    lastTimestamp = timeStamp;

    acceleration.x = acceleration.x ?? 0;
    acceleration.y = acceleration.y ?? 0;
    acceleration.z = acceleration.z ?? 0;
  }

  if (rotationRate) {
    gyroscope.x = rotationRate.alpha ?? 0;
    gyroscope.y = rotationRate.beta ?? 0;
    gyroscope.z = rotationRate.gamma ?? 0;
  }
});

window.addEventListener("deviceorientation", (event) => {
  const { alpha, beta, gamma } = event;

  orientation.alpha = alpha ?? 0;
  orientation.beta = beta ?? 0;
  orientation.gamma = gamma ?? 0;
});

// Update the sensor data table with predictions every 3 seconds
setInterval(() => {
  addSensorDataWithPrediction();
}, 3000); // 3-second interval
</script>
</body>
</html>
